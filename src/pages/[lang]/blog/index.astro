---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// ✅ Primero definimos las rutas
export async function getStaticPaths() {
  return [
    { params: { lang: 'es' } },
    { params: { lang: 'eu' } },
  ];
}

export const prerender = false;

// ✅ Lógica principal
const supported = ['es', 'eu'] as const;
type Lang = typeof supported[number];

const langParam = Astro.params.lang;
const lang: Lang = supported.includes(langParam as Lang) ? (langParam as Lang) : 'es';

// ✅ Obtener posts del collection
const allPosts = await getCollection('blog');

// ✅ Filtrar por idioma y ordenar por fecha descendente
const posts = allPosts
  .filter((p) => p.data.lang === lang)
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

// ✅ Filtrar categorías (quitamos las que son de idioma)
const excludedCategories = ['Castellano', 'Euskera', 'Idioma', 'Lang', 'Language', 'es', 'eu'];
const categories = [...new Set(
  posts.flatMap((p) => p.data.categories || [])
)].filter((cat) => !excludedCategories.includes(cat));
---

<BaseLayout lang={lang} title={lang === 'es' ? 'Blog' : 'Bloga'}>
  <section class="blog-index container">
    {categories.map((category) => (
      <div class="category-section">
        <h2>{category}</h2>
        <ul class="post-list">
          {posts
            .filter((post) => post.data.categories?.includes(category))
            .map((post) => {
              const slugPart = post.slug.split('/').pop();
              return (
                <li class="post-card">
                  <a href={`/${lang}/${slugPart}`}>
                    <h3>{post.data.title}</h3>
                    <p class="post-summary">{post.data.summary}</p>
                    <time class="post-date">
                      {new Date(post.data.pubDate).toLocaleDateString(
                        lang === 'es' ? 'es-ES' : 'eu-ES'
                      )}
                    </time>
                  </a>
                </li>
              );
            })}
        </ul>
      </div>
    ))}
  </section>
</BaseLayout>
